generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ═══════════════════════════════════════════════════
// ENUMS
// ═══════════════════════════════════════════════════

enum UserRole {
  RENTER
  OWNER
  STAFF
  ADMIN
}

enum GarmentStatus {
  DRAFT       // เจ้าของสร้าง ยังไม่เปิดให้เช่า
  AVAILABLE   // พร้อมเช่า
  RESERVED    // ถูกจอง
  RENTED      // กำลังใช้งาน
  MAINTENANCE // ซ่อมบำรุง/ซัก
  RETIRED     // ปลดระวาง
}

enum BookingStatus {
  PENDING           // รอยืนยัน
  AWAITING_PAYMENT  // รอชำระเงิน (มี countdown)
  CONFIRMED         // ยืนยันแล้ว (จ่ายเงินแล้ว)
  AT_HUB            // ชุดอยู่ที่ MeeSai Hub (กำลัง QC + แพ็ค)
  SHIPPING          // ร้านส่งของแล้ว / ไรเดอร์กำลังไปส่ง
  PICKED_UP         // รับชุดแล้ว
  IN_USE            // กำลังใช้งาน (countdown timer)
  AWAITING_RETURN   // รอคืน (กระพริบเมื่อใกล้เวลา)
  RETURNED          // คืนชุดแล้ว
  RETURNED_TO_HUB   // ชุดกลับถึง MeeSai Hub (รอ QC ขากลับ)
  QC_CHECKING       // Hub/ร้านกำลัง QC ตรวจสภาพ
  CLEANING          // ชักแห้ง + บำรุงรักษา
  RETURNED_TO_SHOP  // คืนชุดให้ร้านแล้ว
  COMPLETED         // เสร็จสมบูรณ์
  CANCELLED         // ยกเลิก
  DISPUTED          // มีข้อพิพาท
}

enum WalletTxType {
  TOPUP      // เติมเงิน
  WITHDRAW   // ถอนเงิน
  LOCK       // กันวงเงินมัดจำ
  UNLOCK     // ปลดล็อกมัดจำ
  PAYMENT    // ชำระค่าเช่า
  REFUND     // คืนเงิน
  PENALTY    // หักค่าปรับ
  COMMISSION // ค่า GP ที่ระบบหัก
}

enum ClaimStatus {
  PENDING   // รอผู้เช่ายืนยัน
  ACCEPTED  // ยอมรับ
  DISPUTED  // โต้แย้ง
  RESOLVED  // จบแล้ว
}

enum TicketStatus {
  OPEN          // ใหม่ ยังไม่มีใครรับ
  IN_PROGRESS   // กำลังดูแล
  WAITING       // รอลูกค้าตอบกลับ
  RESOLVED      // แก้ไขแล้ว
  CLOSED        // ปิดแล้ว
}

enum TicketCategory {
  PHOTO_REQUEST  // ขอดูรูปจริง
  SIZE_INQUIRY   // ขอขนาดละเอียด
  AVAILABILITY   // เช็คคิวว่าง
  DEPOSIT_QUERY  // ถามเรื่องมัดจำ
  DELIVERY       // ติดตามการส่ง
  DAMAGE         // แจ้งความเสียหาย
  GENERAL        // อื่นๆ
}

enum EventTheme {
  WEDDING       // งานดอง (งานแต่ง)
  TEMPLE        // งานบุญ/เข้าวัด
  GALA          // งานราตรี (Gala)
  BRIDAL_PARTY  // ชุดเพื่อนเจ้าสาว
  GRADUATION    // งานรับปริญญา
  BUSINESS      // ธุรกิจ/ประชุม
  COSTUME       // คอสตูม/ชุดแฟนซี
  OTHER         // อื่นๆ
}

enum BodyType {
  STANDARD   // มาตรฐาน
  CURVY      // สาวอวบ
  PETITE     // ตัวเล็ก
  TALL       // สูง
  PLUS_SIZE  // ไซส์ใหญ่
}

enum ConditionGrade {
  A_PLUS  // เหมือนใหม่
  A       // ดีมาก
  B       // ดี (มีตำหนิเล็กน้อย)
  C       // พอใช้ (มีตำหนิเห็นได้)
}

// ═══════════════════════════════════════════════════
// CORE MODELS
// ═══════════════════════════════════════════════════

/// User — ผู้ใช้งานทุก Role
model User {
  id        String   @id @default(cuid())
  name      String
  phone     String   @unique
  email     String?
  password  String   // bcrypt hash
  role      UserRole @default(RENTER)
  avatar    String?  // MinIO URL
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  shop         Shop?              @relation("ShopOwner")
  garments     Garment[]          @relation("GarmentOwner")
  bookings     Booking[]          @relation("RenterBookings")
  reviews      Review[]
  wallet       Wallet?
  sizeProfile  SizeProfile?
  wishlists    Wishlist[]
  userCoupons  UserCoupon[]
  damageClaims DamageClaim[]      @relation("ClaimRenter")
  customerTickets SupportTicket[]  @relation("CustomerTickets")
  adminTickets    SupportTicket[]  @relation("AdminTickets")

  @@map("users")
}

/// Wallet — กระเป๋าเงิน
model Wallet {
  id              String   @id @default(cuid())
  availableBalance Int     @default(0) @map("available_balance") // ยอดใช้ได้ (LAK)
  lockedBalance    Int     @default(0) @map("locked_balance")    // ยอดมัดจำ (locked)
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  userId String @unique @map("user_id")
  user   User   @relation(fields: [userId], references: [id])

  transactions WalletTransaction[]

  @@map("wallets")
}

/// WalletTransaction — ประวัติเงินเข้า/ออก
model WalletTransaction {
  id          String       @id @default(cuid())
  type        WalletTxType
  amount      Int          // จำนวนเงิน (LAK)
  description String?      // เช่น "มัดจำ ชุดราตรี DRS-001"
  reference   String?      // bookingId หรือ orderId ที่เกี่ยวข้อง
  createdAt   DateTime     @default(now()) @map("created_at")

  walletId String @map("wallet_id")
  wallet   Wallet @relation(fields: [walletId], references: [id])

  @@index([walletId, createdAt])
  @@map("wallet_transactions")
}

/// SizeProfile — สัดส่วนร่างกาย
model SizeProfile {
  id     String @id @default(cuid())
  bust   Int?   // อก (cm)
  waist  Int?   // เอว (cm)
  hip    Int?   // สะโพก (cm)
  height Int?   // ส่วนสูง (cm)
  weight Int?   // น้ำหนัก (kg)
  notes  String? // หมายเหตุเพิ่มเติม

  userId String @unique @map("user_id")
  user   User   @relation(fields: [userId], references: [id])

  @@map("size_profiles")
}

/// Wishlist — รายการโปรด
model Wishlist {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now()) @map("created_at")

  userId    String @map("user_id")
  user      User   @relation(fields: [userId], references: [id])

  garmentId String  @map("garment_id")
  garment   Garment @relation(fields: [garmentId], references: [id])

  @@unique([userId, garmentId])
  @@map("wishlists")
}

/// Coupon — คูปองส่วนลด (ร้านค้าสร้าง)
model Coupon {
  id          String   @id @default(cuid())
  code        String   @unique
  description String?
  discountPct Int?     @map("discount_pct")    // ส่วนลด % (เช่น 10 = 10%)
  discountAmt Int?     @map("discount_amt")    // ส่วนลดจำนวนเงิน (LAK)
  minOrder    Int      @default(0) @map("min_order") // ขั้นต่ำ
  maxDiscount Int?     @map("max_discount")    // ลดสูงสุด
  usageLimit  Int      @default(100) @map("usage_limit")
  usedCount   Int      @default(0) @map("used_count")
  startsAt    DateTime @map("starts_at")
  expiresAt   DateTime @map("expires_at")
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")

  shopId String? @map("shop_id") // null = platform-wide coupon
  shop   Shop?   @relation(fields: [shopId], references: [id])

  userCoupons UserCoupon[]

  @@map("coupons")
}

/// UserCoupon — คูปองที่ผู้เช่าเก็บ
model UserCoupon {
  id       String    @id @default(cuid())
  usedAt   DateTime? @map("used_at")
  claimedAt DateTime @default(now()) @map("claimed_at")

  userId   String @map("user_id")
  user     User   @relation(fields: [userId], references: [id])

  couponId String @map("coupon_id")
  coupon   Coupon @relation(fields: [couponId], references: [id])

  @@unique([userId, couponId])
  @@map("user_coupons")
}

/// DamageClaim — รายงานความเสียหาย + ข้อพิพาท
model DamageClaim {
  id             String      @id @default(cuid())
  description    String      // อธิบายจุดเสียหาย
  estimatedCost  Int         @map("estimated_cost") // ราคาประเมิน (LAK)
  status         ClaimStatus @default(PENDING)
  resolution     String?     // ผลการตัดสิน
  photoBefore    String?     @map("photo_before") // MinIO URL (QC ขาออก)
  photoAfter     String?     @map("photo_after")  // MinIO URL (QC ขาเข้า)
  photoEvidence  String?     @map("photo_evidence") // MinIO URL (จุดเสียหาย)
  createdAt      DateTime    @default(now()) @map("created_at")
  resolvedAt     DateTime?   @map("resolved_at")

  bookingId String  @map("booking_id")
  booking   Booking @relation(fields: [bookingId], references: [id])

  renterId String @map("renter_id")
  renter   User   @relation("ClaimRenter", fields: [renterId], references: [id])

  @@index([bookingId])
  @@map("damage_claims")
}

// ═══════════════════════════════════════════════════
// PRODUCT MODELS
// ═══════════════════════════════════════════════════

/// Shop — ร้านค้า/แบรนด์ (1 Owner = 1 Shop)
model Shop {
  id          String  @id @default(cuid())
  nameLo      String  @map("name_lo")
  nameEn      String? @map("name_en")
  description String?
  logo        String? // MinIO URL
  phone       String?
  address     String?
  isVerified  Boolean @default(false) @map("is_verified")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Owner (1:1)
  ownerId  String   @unique @map("owner_id")
  owner    User     @relation("ShopOwner", fields: [ownerId], references: [id])

  // Relations
  garments Garment[]
  coupons  Coupon[]

  @@map("shops")
}

/// Category — หมวดหมู่ชุด
model Category {
  id        String @id @default(cuid())
  nameLo    String @map("name_lo")
  nameEn    String @map("name_en")
  icon      String // Lucide icon name
  slug      String @unique
  sortOrder Int    @default(0) @map("sort_order")

  garments Garment[]

  @@map("categories")
}

/// Garment — ชุดแฟชั่น (รวม Product + Asset concept จาก V1)
model Garment {
  id          String        @id @default(cuid())
  code        String        @unique // e.g. "DRS-001"
  titleLo     String        @map("title_lo")
  titleEn     String?       @map("title_en")
  description String?
  size        String        // S, M, L, XL, FREE
  color       String?
  colorHex    String?       @map("color_hex") // #hex for skin-tone matching
  brand       String?
  rentalPrice Int           @map("rental_price") // ค่าเช่า (LAK) ต่อครั้ง
  deposit     Int           @default(0) // ค่ามัดจำ (Hold Amount)
  status      GarmentStatus @default(DRAFT)
  // Journey: Condition Report
  condition      String?        // หมายเหตุสภาพ (legacy)
  conditionGrade ConditionGrade @default(A_PLUS) @map("condition_grade")
  defectNotes    String?        @map("defect_notes") // อธิบายตำหนิ เช่น "รอยด้ายรัน 2mm ที่ชายกระโปรง"
  // Journey: Size Ranges (cm) for Fit Assurance
  bustMin    Int?   @map("bust_min")
  bustMax    Int?   @map("bust_max")
  waistMin   Int?   @map("waist_min")
  waistMax   Int?   @map("waist_max")
  hipMin     Int?   @map("hip_min")
  hipMax     Int?   @map("hip_max")
  heightMin  Int?   @map("height_min")
  heightMax  Int?   @map("height_max")
  // Journey: Contextual Tags
  eventThemes  EventTheme[]  @map("event_themes")  // งานดอง, งานบุญ, ราตรี
  bodyTypes    BodyType[]    @map("body_types")    // สาวอวบ, ตัวเล็ก
  // Journey: Operations
  backupSizeFee Int    @default(50000) @map("backup_size_fee") // ค่าส่งไซส์สำรอง (LAK)
  bufferDays    Int    @default(1) @map("buffer_days") // Buffer days for laundry after return
  totalRentals  Int    @default(0) @map("total_rentals")
  isFeatured    Boolean @default(false) @map("is_featured")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Relations
  categoryId String   @map("category_id")
  category   Category @relation(fields: [categoryId], references: [id])

  shopId String @map("shop_id")
  shop   Shop   @relation(fields: [shopId], references: [id])

  ownerId String @map("owner_id")
  owner   User   @relation("GarmentOwner", fields: [ownerId], references: [id])

  images    GarmentImage[]
  bookings  Booking[]
  wishlists Wishlist[]

  @@index([status])
  @@index([categoryId])
  @@index([shopId])
  @@map("garments")
}

/// GarmentImage — รูปภาพชุด (แยก table สำหรับ ordering + management)
model GarmentImage {
  id        String @id @default(cuid())
  url       String // MinIO URL
  alt       String?
  sortOrder Int    @default(0) @map("sort_order")

  garmentId String  @map("garment_id")
  garment   Garment @relation(fields: [garmentId], references: [id], onDelete: Cascade)

  @@map("garment_images")
}

// ═══════════════════════════════════════════════════
// BOOKING & REVIEW
// ═══════════════════════════════════════════════════

/// Booking — การจองชุด
model Booking {
  id          String        @id @default(cuid())
  eventDate   DateTime      @map("event_date")    // วันงาน
  pickupDate  DateTime      @map("pickup_date")   // วันรับชุด
  returnDate  DateTime      @map("return_date")   // วันคืนชุด
  bufferEnd   DateTime      @map("buffer_end")    // วันสิ้นสุด buffer (returnDate + bufferDays)
  // Fees (IA = Itemized Amount)
  rentalFee   Int           @map("rental_fee")     // ค่าเช่า
  depositFee  Int           @default(0) @map("deposit_fee") // ค่ามัดจำ
  serviceFee  Int           @default(0) @map("service_fee") // ค่าบริการ
  deliveryFee Int           @default(0) @map("delivery_fee") // ค่าส่ง
  laundryFee  Int           @default(0) @map("laundry_fee")  // ค่าซัก
  totalAmount Int           @map("total_amount")   // ยอดรวม (ค่าจ่ายจริง)
  holdAmount  Int           @default(0) @map("hold_amount")  // วงเงินประกัน (ไม่ตัดเงินจริง)
  status      BookingStatus @default(PENDING)
  notes       String?
  // Backup Size Option
  backupSizeRequested Boolean @default(false) @map("backup_size_requested")
  // Payment tracking
  paidAt      DateTime?     @map("paid_at")        // เวลาชำระ
  payDeadline DateTime?     @map("pay_deadline")   // หมดเขตชำระ
  // Shipping
  trackingCode String?      @map("tracking_code")  // เลข tracking
  shippedAt    DateTime?    @map("shipped_at")     // เวลาส่ง
  deliveredAt  DateTime?    @map("delivered_at")   // เวลาลูกค้ารับ
  returnedAt   DateTime?    @map("returned_at")    // เวลาคืน
  qcPassedAt   DateTime?    @map("qc_passed_at")   // เวลา QC ผ่าน
  // Pre-Return Self Check
  preReturnPhotos String[]  @map("pre_return_photos") // URLs ภาพก่อนส่งคืน
  // Extension
  extendedDays Int          @default(0) @map("extended_days")
  extensionFee Int          @default(0) @map("extension_fee")
  // Hub Fulfillment
  hubReceivePhotos String[] @map("hub_receive_photos")  // รูปตอนรับชุดเข้า Hub
  hubSendPhotos    String[] @map("hub_send_photos")     // รูปตอนส่งออกจาก Hub
  hubChecklist     String[] @map("hub_checklist")       // QC checklist items passed
  hubReceivedAt    DateTime? @map("hub_received_at")    // เวลารับเข้า Hub
  hubSentAt        DateTime? @map("hub_sent_at")        // เวลาส่งออกจาก Hub
  createdAt   DateTime      @default(now()) @map("created_at")
  updatedAt   DateTime      @updatedAt @map("updated_at")

  // Relations
  renterId String  @map("renter_id")
  renter   User    @relation("RenterBookings", fields: [renterId], references: [id])

  garmentId String  @map("garment_id")
  garment   Garment @relation(fields: [garmentId], references: [id])

  review         Review?
  damageClaims   DamageClaim[]
  supportTickets SupportTicket[]

  @@index([garmentId, pickupDate, returnDate])
  @@index([renterId])
  @@index([status])
  @@map("bookings")
}

/// Review — รีวิวจากผู้เช่า
model Review {
  id        String   @id @default(cuid())
  rating    Int      // 1-5 stars
  comment   String?
  createdAt DateTime @default(now()) @map("created_at")

  bookingId String  @unique @map("booking_id")
  booking   Booking @relation(fields: [bookingId], references: [id])

  userId String @map("user_id")
  user   User   @relation(fields: [userId], references: [id])

  @@map("reviews")
}

/// SystemConfig — ค่าตั้งระบบ
model SystemConfig {
  id    String  @id @default(cuid())
  key   String  @unique
  value String
  note  String?

  @@map("system_configs")
}

/// SupportTicket — Concierge Ticket System
model SupportTicket {
  id         String         @id @default(cuid())
  category   TicketCategory
  status     TicketStatus   @default(OPEN)
  subject    String
  message    String
  response   String?
  priority   Int            @default(0)  // 0=normal, 1=high, 2=urgent
  resolvedAt DateTime?      @map("resolved_at")
  createdAt  DateTime       @default(now()) @map("created_at")
  updatedAt  DateTime       @updatedAt @map("updated_at")

  // Customer
  customerId String @map("customer_id")
  customer   User   @relation("CustomerTickets", fields: [customerId], references: [id])

  // Booking context (optional)
  bookingId  String?  @map("booking_id")
  booking    Booking? @relation(fields: [bookingId], references: [id])

  // Assigned admin
  assigneeId String? @map("assignee_id")
  assignee   User?   @relation("AdminTickets", fields: [assigneeId], references: [id])

  @@index([status, createdAt])
  @@index([customerId])
  @@map("support_tickets")
}
